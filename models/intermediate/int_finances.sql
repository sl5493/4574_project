WITH daily_orders AS (
    SELECT
        DATE(o.ORDER_DATE) AS ORDER_DATE,
        SUM(o.TOTAL_PAID) AS DAILY_SALES, 
        SUM(CASE WHEN o.IS_REFUNDED THEN o.PRICE_PAID ELSE 0 END) AS DAILY_REFUNDS
    FROM {{ref ('int_orders')}} o
    GROUP BY DATE(o.ORDER_DATE)
),

daily_expenses AS (
    SELECT
        e.EXPENSE_DATE,
        SUM(e.TOTAL_EXPENSE) AS DAILY_EXPENSES
    FROM {{ref ('int_expenses')}} e
    GROUP BY e.EXPENSE_DATE
),

financials AS (
    SELECT
        COALESCE(do.ORDER_DATE, de.EXPENSE_DATE) AS DATE,
        COALESCE(do.DAILY_SALES, 0) AS TOTAL_SALES,
        COALESCE(do.DAILY_REFUNDS, 0) AS TOTAL_REFUNDS,
        COALESCE(de.DAILY_EXPENSES, 0) AS TOTAL_EXPENSES,
        (COALESCE(do.DAILY_SALES, 0) - COALESCE(do.DAILY_REFUNDS, 0) - COALESCE(de.DAILY_EXPENSES, 0)) AS NET_PROFIT
    FROM daily_orders do
    FULL OUTER JOIN daily_expenses de ON do.ORDER_DATE = de.EXPENSE_DATE
)

SELECT
    f.DATE,
    SUM(f.TOTAL_SALES) AS TOTAL_REVENUE,
    SUM(f.TOTAL_REFUNDS) AS TOTAL_REFUNDS,
    SUM(f.TOTAL_EXPENSES) AS TOTAL_EXPENSES,
    SUM(f.NET_PROFIT) AS NET_PROFIT
FROM financials f
GROUP BY f.DATE
ORDER BY f.DATE